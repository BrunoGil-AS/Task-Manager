import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.resolve(__dirname, "..", "..", "..");

const controllerFiles = [
  path.resolve(projectRoot, "back/task-manager/src/tasks/controllers/TaskController.ts"),
  path.resolve(projectRoot, "back/task-manager/src/users/controllers/UserController.ts"),
  path.resolve(projectRoot, "back/task-manager/src/auth/controllers/authController.ts"),
];

const endpointRegex = /Handles `([A-Z]+) ([^`]+)`/g;
const methodRegex = /async\s+([A-Za-z0-9_]+)\s*\(/g;

function parseController(filePath) {
  const source = fs.readFileSync(filePath, "utf8");
  const endpoints = [];
  const endpointMatches = [...source.matchAll(endpointRegex)];
  const methodMatches = [...source.matchAll(methodRegex)];

  for (let i = 0; i < endpointMatches.length; i += 1) {
    const endpoint = endpointMatches[i];
    const method = methodMatches[i];
    endpoints.push({
      httpMethod: endpoint[1],
      routePath: endpoint[2],
      methodName: method ? method[1] : "unknown",
      source: path.relative(projectRoot, filePath).replaceAll("\\", "/"),
    });
  }

  return endpoints;
}

const allEndpoints = controllerFiles.flatMap(parseController);

const rows = allEndpoints
  .map(
    (item) =>
      `| \`${item.httpMethod}\` | \`${item.routePath}\` | \`${item.methodName}\` | \`${item.source}\` |`,
  )
  .join("\n");

const output = `# API Docs Generated From JSDoc

This file is generated by \`back/task-manager/scripts/generate-api-from-jsdoc.mjs\`.

| Method | Path | Controller Method | Source |
| --- | --- | --- | --- |
${rows}
`;

const outputPath = path.resolve(projectRoot, "docs/API_FROM_JSDOC.md");
fs.writeFileSync(outputPath, output, "utf8");
console.log(`Generated ${path.relative(projectRoot, outputPath)}`);
